<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

    <!-- <link rel="stylesheet" href="https://esm.sh/bulma@1.0.2/css/bulma.min.css"> -->
    <!-- <link rel="stylesheet" href="https://esm.sh/@fortawesome/fontawesome-free@5.15.3/css/all.min.css"> -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>DIESEL</title>
</head>

<body>
    <div class="section" id="app"></div>
    <script src="diesel.js"></script>
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@17.0.2?dev&bundle",
                "react-dom": "https://esm.sh/react-dom@?17.0.2dev&bundle"
            }
        }
    </script>
	<script type="module">
		import React, { createElement as h } from "react";
		import ReactDOM from "react-dom";

		function evaluateDIESEL(expression) {
			// Allocate memory for strings in the WebAssembly memory space
			const inPtr = Module.allocateUTF8(expression);
			const outPtr = Module.allocateUTF8("");

			const status = Module._diesel(inPtr, outPtr);

			const output = Module.UTF8ToString(outPtr);
			return { status, output };
		}

		class App extends React.Component {
			state = {
				expression: "$(+,1,2,3)",
				history: []
			}

			componentDidMount() {
				// Load history from localstorage
				localStorage.getItem("history") && this.setState({
					history: JSON.parse(localStorage.getItem("history"))
				});

				// Load expression from URL
				const url = new URL(window.location);
				const params = new URLSearchParams(url.search);
				const queryValue = params.get('query');
				if (queryValue && queryValue.length > 1) {
					// Decode the query parameter (if necessary)
					const decodedValue = decodeURIComponent(queryValue);
					this.setState({
						expression: decodedValue
					});
				}
			}

			#onChange = (event) => {
				const value = event.target.value;

				const url = new URL(window.location);
				url.searchParams.set('query', value);
				window.history.replaceState({}, '', url);

				this.setState({
					expression: value,
				});
			}


			#onSubmit = () => {
				const { expression } = this.state;
				if (this.state.history.length) {
					if (this.state.history[0].expression === expression) {
						return;
					}
				}
				const now = new Date().getTime();
				const nowISO = new Date(now).toISOString().split("T").join(" ").split(".")[0];
				const result = evaluateDIESEL(expression);

				localStorage.setItem("history", JSON.stringify([
					...this.state.history,
					{ expression, result, date: now, dateISO: nowISO }
				]));

				this.setState({
					history: [
						...this.state.history,
						{ expression, result, date: now, dateISO: nowISO }
					]
				});
			}

			render() {
				return h("div", null, [
					h("nav", { className: "navbar navbar-expand-lg bg-body-tertiary" }, [
						h("div", { className: "container-fluid" }, [
							h("a", { className: "navbar-brand", href: "#"}, "DIESEL")
						])
					]),
					h("br"),
					h("div", { className: "container" }, [
						h("p", null, [
							h("small", null, "This Dumb Interpretively Executed String Expression Language. "),
							// "This Dumb Interpretively Executed String Expression Language is the kernel of a macro language you can customise by adding C code and embedding it into your program. ",
							h("a", { href: "https://github.com/dderevjanik/diesel-js/blob/main/docs/DIESEL.md "}, "DIESEL documentation"),
						]),
						h("p", null, [
							h("b", null, "Enter a DIESEL expression below.")
						]),
						h("div", { className: "input-group" }, [
							h("input", {
								className: "form-control",
								placeholder: "$(+,1,2,3,4,5)",
								onChange: this.#onChange,
								value: this.state.expression
							}),
							h("button", {
								className: "btn btn-primary",
								onClick: this.#onSubmit,
							}, "Eval"),
						])
					]),
					h("br"),
					h("div", { className: "container" }, this.state.history.sort((a, b) => new Date(b.date) - new Date(a.date)).map((item) => {
						if (item.result.status === 0) {
							return h("div", { key: item.date, className: "alert alert-success", role: "alert" }, [
								h("div", null, [
									h("b", null, "<< "),
									item.expression
								]),
								h("div", null, [
									h("b", null, ">> "),
									item.result.output
								]),
								h("div", { className: "text-end" },
									h("small", null, item.dateISO))
							]);
						} else {
							return h("div", { key: item.date, className: "alert alert-danger", role: "alert" }, [
								h("div", null, [
									h("b", null, "<< "),
									item.expression
								]),
								h("div", null, [
									h("b", null, ">> "),
									item.result.output
								]),
								h("div", null, [
									h("b", null, "Unexpected Error: "),
									item.result.status
								]),
								h("div", { className: "text-end" },
									h("small", null, item.dateISO))
							]);
						}
					}))
				]);
			}
		}

		ReactDOM.render(h(App), document.getElementById("app"));
	</script>
</body>

</html>

